{
  "name": "专 驻 专",
  "nodes": [
  {
    "parameters": {
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "Twilio API",
      "resource": "message",
      "operation": "send",
      "from": "whatsapp:+14155238886",
      "to": "whatsapp:={{ $json.userPhone }}",
      "content": "={{ $json.initialMessage }}"
    },
    "name": "Twilio - 拽转 驻转 砖转",
    "type": "n8n-nodes-base.twilio",
    "typeVersion": 1,
    "position": [
      240,
      300
    ]
  },
  {
    "parameters": {
      "httpMethod": "POST",
      "options": {},
      "url": "https://api.openai.com/v1/chat/completions",
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "ChatGPT API",
      "sendBody": true,
      "bodyParameters": {
        "parameters": [
          {
            "name": "model",
            "value": "gpt-4"
          },
          {
            "name": "messages",
            "value": "={{ [\n  {\n    \"role\": \"system\",\n    \"content\": \"转 驻 砖 专. 转驻拽  砖 注 注 砖转砖,  转 驻 砖, 爪专 注驻转. 住祝 砖 转爪专 驻 转 砖转砖 注-驻 住驻专 驻专专: 专专/拽住专专 (1-10), 转 注 注拽专 (专砖 驻专转 驻住拽), 转专 专转 (专砖 驻专转 驻住拽), 住 拽爪 注祝 (拽 转/转 转/ 驻注)\"\n  },\n  {\n    \"role\": \"user\",\n    \"content\": $json.incomingMessage\n  }\n]"
          },
          {
            "name": "temperature",
            "value": 0.7
          }
        ]
      },
      "sendHeaders": true,
      "headerParameters": {
        "parameters": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ]
      }
    },
    "name": "ChatGPT - 驻 砖",
    "type": "n8n-nodes-base.httpRequest",
    "typeVersion": 1,
    "position": [
      460,
      300
    ]
  },
  {
    "parameters": {
      "conditions": {
        "string": [
          {
            "value1": "={{ $json.session_stage }}",
            "operation": "isNotEmpty"
          }
        ]
      }
    },
    "name": "拽转 砖 砖",
    "type": "n8n-nodes-base.if",
    "typeVersion": 1,
    "position": [
      680,
      300
    ]
  },
  {
    "parameters": {
      "functionCode": "// 拽 砖抓 转 转砖转 驻 转转 -API 拽注 转 砖  砖\nconst response = JSON.parse(items[0].json).choices[0].message.content;\nlet sessionStage = items[0].json.session_stage || 'initial';\nlet userProfile = items[0].json.userProfile || {};\n\n//   砖 专砖, 转 转 转 驻\nif (sessionStage === 'initial') {\n  sessionStage = 'profiling';\n} \n//   砖 驻 砖 住驻拽 注, 注专 砖 \nelse if (sessionStage === 'profiling' && response.includes('驻')) {\n  sessionStage = 'completed';\n  \n  // 抓 驻 砖转砖 转砖\n  if (response.includes('专专/拽住专专:')) {\n    const introExtroMatch = response.match(/专专\\/拽住专专:\\s*(\\d+)/i);\n    if (introExtroMatch) {\n      userProfile.introExtroScore = parseInt(introExtroMatch[1]);\n    }\n  }\n  \n  if (response.includes('转 注:')) {\n    const interestsMatch = response.match(/转 注:\\s*([^\\n]+)/i);\n    if (interestsMatch) {\n      userProfile.interests = interestsMatch[1].split(',').map(i => i.trim());\n    }\n  }\n  \n  if (response.includes('转专 专转:')) {\n    const challengesMatch = response.match(/转专 专转:\\s*([^\\n]+)/i);\n    if (challengesMatch) {\n      userProfile.socialChallenges = challengesMatch[1].split(',').map(i => i.trim());\n    }\n  }\n  \n  if (response.includes('住 拽爪 注祝:')) {\n    const groupPrefMatch = response.match(/住 拽爪 注祝:\\s*([^\\n]+)/i);\n    if (groupPrefMatch) {\n      userProfile.preferredGroupType = groupPrefMatch[1].trim();\n    }\n  }\n}\n\n// 住驻转 注 注 驻\nreturn [\n  {\n    json: {\n      ...items[0].json,\n      therapistResponse: response,\n      session_stage: sessionStage,\n      userProfile: userProfile\n    }\n  }\n];"
    },
    "name": "注 转砖转 驻",
    "type": "n8n-nodes-base.function",
    "typeVersion": 1,
    "position": [
      900,
      300
    ]
  },
  {
    "parameters": {
      "conditions": {
        "string": [
          {
            "value1": "={{ $json.session_stage }}",
            "value2": "completed",
            "operation": "equal"
          }
        ]
      }
    },
    "name": " 驻 砖?",
    "type": "n8n-nodes-base.if",
    "typeVersion": 1,
    "position": [
      1120,
      300
    ]
  },
  {
    "parameters": {
      "operation": "upsert",
      "documentId": "={{ $json.userId }}",
      "fields": {
        "values": [
          {
            "name": "userId",
            "value": "={{ $json.userId }}"
          },
          {
            "name": "name",
            "value": "={{ $json.userName }}"
          },
          {
            "name": "phone",
            "value": "={{ $json.userPhone }}"
          },
          {
            "name": "introExtroScore",
            "value": "={{ $json.userProfile.introExtroScore }}"
          },
          {
            "name": "interests",
            "value": "={{ $json.userProfile.interests }}"
          },
          {
            "name": "socialChallenges",
            "value": "={{ $json.userProfile.socialChallenges }}"
          },
          {
            "name": "preferredGroupType",
            "value": "={{ $json.userProfile.preferredGroupType }}"
          },
          {
            "name": "assignedGroup",
            "value": ""
          }
        ]
      }
    },
    "name": "砖专转 驻专驻 砖转砖",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      1340,
      180
    ]
  },
  {
    "parameters": {
      "httpMethod": "POST",
      "options": {},
      "url": "https://api.openai.com/v1/chat/completions",
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "ChatGPT API",
      "sendBody": true,
      "bodyParameters": {
        "parameters": [
          {
            "name": "model",
            "value": "gpt-4"
          },
          {
            "name": "messages",
            "value": "={{ [\n  {\n    \"role\": \"system\",\n    \"content\": \"转  砖 专 驻 专. 转驻拽 转 砖转砖 拽爪转 转转. 转 拽 转 驻 砖转砖 转 专砖转 拽爪转 拽转. 注 专 转 拽爪 转 转专   爪专 拽爪 砖.\"\n  },\n  {\n    \"role\": \"user\",\n    \"content\": \" 转 转 砖转砖  拽爪 转:\\n\\n砖: \" + $json.userName + \"\\n爪 专专/拽住专专: \" + $json.userProfile.introExtroScore + \"\\n转 注: \" + $json.userProfile.interests.join(\", \") + \"\\n转专 专转: \" + $json.userProfile.socialChallenges.join(\", \") + \"\\n住 拽爪 注祝: \" + $json.userProfile.preferredGroupType + \"\\n\\n拽爪转 拽转 :\\n\" + $node[\"Get Existing Groups\"].json.groupsDescription\n  }\n]"
          },
          {
            "name": "temperature",
            "value": 0.5
          }
        ]
      }
    },
    "name": "转转 砖转砖 拽爪",
    "type": "n8n-nodes-base.httpRequest",
    "typeVersion": 1,
    "position": [
      1560,
      180
    ]
  },
  {
    "parameters": {
      "operation": "find",
      "collection": "groups",
      "options": {}
    },
    "name": "Get Existing Groups",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      1340,
      380
    ]
  },
  {
    "parameters": {
      "functionCode": "// 注 拽爪转 拽转 驻专 转专\nconst groups = items[0].json.documents || [];\n\nlet groupsDescription = '';\nif (groups.length === 0) {\n  groupsDescription = ' 拽爪转 拽转. 砖 爪专 拽爪 砖.';\n} else {\n  groups.forEach((group, index) => {\n    groupsDescription += `拽爪 ${index + 1}: ${group.name}\\n`;\n    groupsDescription += `转专: ${group.description}\\n`;\n    groupsDescription += `转 注: ${group.interests.join(', ')}\\n`;\n    groupsDescription += `住驻专 砖转转驻: ${group.members.length}/${group.maxSize}\\n`;\n    groupsDescription += `驻 拽爪: ${group.groupType}\\n\\n`;\n  });\n}\n\nreturn [{\n  json: {\n    groups: groups,\n    groupsDescription: groupsDescription\n  }\n}];"
    },
    "name": "注 拽爪转 拽转",
    "type": "n8n-nodes-base.function",
    "typeVersion": 1,
    "position": [
      1340,
      480
    ]
  },
  {
    "parameters": {
      "functionCode": "// 转 转砖 砖    爪专 拽爪 砖  住祝 拽转\nconst managerResponse = JSON.parse(items[0].json).choices[0].message.content;\nconst groups = items[0].json.groups || [];\n\nlet assignedGroupId = null;\nlet newGroup = null;\n\n// 拽  爪专 爪专 拽爪 砖\nif (managerResponse.includes('爪专 拽爪 砖') || groups.length === 0) {\n  // 驻拽转 驻 拽爪 砖 转砖转 \n  let groupName = \"拽爪 砖\";\n  let groupDescription = \"拽爪转 转\";\n  let groupInterests = items[0].json.userProfile.interests;\n  let groupType = items[0].json.userProfile.preferredGroupType;\n  \n  // 住 抓 砖 转 转专 拽爪\n  const nameMatch = managerResponse.match(/砖 拽爪[:\\s]*([^\\n]+)/i);\n  if (nameMatch) {\n    groupName = nameMatch[1].trim();\n  }\n  \n  // 住 抓 转专\n  const descMatch = managerResponse.match(/转专[:\\s]*([^\\n]+)/i);\n  if (descMatch) {\n    groupDescription = descMatch[1].trim();\n  }\n  \n  newGroup = {\n    name: groupName,\n    description: groupDescription,\n    interests: groupInterests,\n    groupType: groupType,\n    members: [items[0].json.userId],\n    maxSize: 9,  // 专专转  拽住  拽爪\n    whatsappGroupId: \"\",  // 砖 砖\n    events: []\n  };\n} \n// 专转, 爪  拽爪 拽转 住祝 转 砖转砖\nelse {\n  // 住 抓 转 住驻专 拽爪\n  let groupIndex = null;\n  const groupMatch = managerResponse.match(/拽爪 *(\\d+)/i);\n  if (groupMatch) {\n    groupIndex = parseInt(groupMatch[1]) - 1;  // -1  拽住 转 -0\n  }\n  \n  if (groupIndex !== null && groupIndex >= 0 && groupIndex < groups.length) {\n    assignedGroupId = groups[groupIndex]._id;\n  } else {\n    //   爪 拽爪 驻专砖转, 专 转 拽爪 专砖\n    if (groups.length > 0) {\n      assignedGroupId = groups[0]._id;\n    }\n  }\n}\n\nreturn [{\n  json: {\n    ...items[0].json,\n    managerDecision: managerResponse,\n    assignedGroupId: assignedGroupId,\n    newGroup: newGroup\n  }\n}];"
    },
    "name": "注 转 ",
    "type": "n8n-nodes-base.function",
    "typeVersion": 1,
    "position": [
      1780,
      180
    ]
  },
  {
    "parameters": {
      "conditions": {
        "boolean": [
          {
            "value1": "={{ $json.newGroup !== null }}",
            "value2": true,
            "operation": "equal"
          }
        ]
      }
    },
    "name": " 爪专 拽爪 砖?",
    "type": "n8n-nodes-base.if",
    "typeVersion": 1,
    "position": [
      2000,
      180
    ]
  },
  {
    "parameters": {
      "operation": "create",
      "collection": "groups",
      "fields": {
        "values": [
          {
            "name": "name",
            "value": "={{ $json.newGroup.name }}"
          },
          {
            "name": "description",
            "value": "={{ $json.newGroup.description }}"
          },
          {
            "name": "interests",
            "value": "={{ $json.newGroup.interests }}"
          },
          {
            "name": "groupType",
            "value": "={{ $json.newGroup.groupType }}"
          },
          {
            "name": "members",
            "value": "={{ $json.newGroup.members }}"
          },
          {
            "name": "maxSize",
            "value": "={{ $json.newGroup.maxSize }}"
          },
          {
            "name": "whatsappGroupId",
            "value": ""
          },
          {
            "name": "events",
            "value": "={{ $json.newGroup.events }}"
          }
        ]
      }
    },
    "name": "爪专转 拽爪 砖",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      2240,
      60
    ]
  },
  {
    "parameters": {
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "Twilio API",
      "resource": "messagingService",
      "operation": "create",
      "friendlyName": "={{ $json.newGroup.name }}",
      "inboundRequestUrl": "={{ $workflow.staticWebhookUrl }}?service=group"
    },
    "name": "Twilio - 爪专转 砖专转 注转 拽爪",
    "type": "n8n-nodes-base.twilio",
    "typeVersion": 1,
    "position": [
      2460,
      60
    ]
  },
  {
    "parameters": {
      "operation": "update",
      "collection": "groups",
      "document": "={{ $json.workflowData.lastNodeOutput.insertedId }}",
      "updateKey": "whatsappGroupId",
      "updateValue": "={{ $json.sid }}"
    },
    "name": "注  砖专转 注转",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      2680,
      60
    ]
  },
  {
    "parameters": {
      "operation": "update",
      "collection": "users",
      "document": "={{ $json.userId }}",
      "updateKey": "assignedGroup",
      "updateValue": "={{ $json.workflowData.lastNodeOutput.insertedId }}"
    },
    "name": "注 拽爪 砖转砖 (砖)",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      2900,
      60
    ]
  },
  {
    "parameters": {
      "operation": "update",
      "document": "={{ $json.assignedGroupId }}",
      "collection": "groups",
      "fields": {
        "values": [
          {
            "name": "members",
            "value": "={{ $node[\"Get Group Details\"].json.members.concat($json.userId) }}"
          }
        ]
      }
    },
    "name": "住驻转 砖转砖 拽爪 拽转",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      2460,
      300
    ]
  },
  {
    "parameters": {
      "operation": "update",
      "collection": "users",
      "document": "={{ $json.userId }}",
      "updateKey": "assignedGroup",
      "updateValue": "={{ $json.assignedGroupId }}"
    },
    "name": "注 拽爪 砖转砖 (拽转)",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      2680,
      300
    ]
  },
  {
    "parameters": {
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "Twilio API",
      "resource": "participant",
      "operation": "add",
      "messagingServiceSid": "={{ $node[\"Get Group Details\"].json.whatsappGroupId }}",
      "userIdentity": "whatsapp:{{ $json.userPhone }}"
    },
    "name": "Twilio - 住驻转 砖转砖 拽爪",
    "type": "n8n-nodes-base.twilio",
    "typeVersion": 1,
    "position": [
      2900,
      300
    ]
  },
  {
    "parameters": {
      "operation": "findById",
      "collection": "groups",
      "document": "={{ $json.assignedGroupId }}"
    },
    "name": "Get Group Details",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      2240,
      300
    ]
  },
  {
    "parameters": {
      "triggerTimes": {
        "item": [
          {
            "mode": "everyX",
            "value": 1,
            "unit": "hours"
          }
        ]
      }
    },
    "name": "Scheduler - 住专拽转 专注",
    "type": "n8n-nodes-base.scheduleTrigger",
    "typeVersion": 1,
    "position": [
      240,
      740
    ]
  },
  {
    "parameters": {
      "url": "https://api.eventbrite.com/v3/events/search",
      "options": {
        "qs": {
          "location.address": "Tel Aviv, Israel",
          "categories": "107,101,103,105,108",
          "start_date.range_start": "={{ $today }}",
          "sort_by": "date"
        }
      },
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "Eventbrite API"
    },
    "name": "驻砖 专注 -Eventbrite",
    "type": "n8n-nodes-base.httpRequest",
    "typeVersion": 1,
    "position": [
      460,
      740
    ]
  },
  {
    "parameters": {
      "url": "https://api.meetup.com/find/upcoming_events",
      "options": {
        "qs": {
          "lat": "32.0853",
          "lon": "34.7818",
          "radius": "25",
          "text": "therapy mental-health support-group social"
        }
      },
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "Meetup API"
    },
    "name": "驻砖 专注 -Meetup",
    "type": "n8n-nodes-base.httpRequest",
    "typeVersion": 1,
    "position": [
      460,
      900
    ]
  },
  {
    "parameters": {
      "functionCode": "// 注 转 专注  拽专转\nconst eventbriteEvents = items[0].json.events || [];\nconst meetupEvents = items[1].json.events || [];\n\n// 专转 专注 Eventbrite 驻专 \nconst processedEventbriteEvents = eventbriteEvents.map(event => ({\n  source: 'Eventbrite',\n  id: event.id,\n  name: event.name.text,\n  description: event.description.text,\n  startDate: event.start.local,\n  endDate: event.end.local,\n  url: event.url,\n  location: event.venue ? event.venue.address.localized_address_display : 'Online',\n  categories: event.categories ? event.categories.map(c => c.name).join(', ') : '',\n  isOnline: event.online_event,\n  price: event.is_free ? 'Free' : 'Paid',\n  imageUrl: event.logo ? event.logo.url : ''\n}));\n\n// 专转 专注 Meetup 驻专 \nconst processedMeetupEvents = meetupEvents.map(event => ({\n  source: 'Meetup',\n  id: event.id,\n  name: event.name,\n  description: event.description,\n  startDate: event.local_date + 'T' + event.local_time,\n  endDate: '',  // Meetup  转 住驻拽  住\n  url: event.link,\n  location: event.venue ? `${event.venue.name}, ${event.venue.address_1}, ${event.venue.city}` : 'Online',\n  categories: event.group.name,\n  isOnline: !event.venue,\n  price: 'N/A',  // Meetup  转 住驻拽 注 注 专\n  imageUrl: event.featured_photo ? event.featured_photo.photo_link : ''\n}));\n\n//   专注\nconst allEvents = [...processedEventbriteEvents, ...processedMeetupEvents];\n\nreturn [{\n  json: {\n    events: allEvents\n  }\n}];"
    },
    "name": "注 转 专注",
    "type": "n8n-nodes-base.function",
    "typeVersion": 1,
    "position": [
      680,
      820
    ]
  },
  {
    "parameters": {
      "operation": "find",
      "collection": "groups"
    },
    "name": "拽转  拽爪转",
    "type": "n8n-nodes-base.mongoDb",
    "typeVersion": 1,
    "position": [
      900,
      820
    ]
  },
  {
    "parameters": {
      "functionCode": "// 注专  拽爪, 爪 转 专注 转 转专\nconst groups = items[0].json.documents || [];\nconst events = items[0].json.events || [];\n\n// 爪专 专砖转 砖转 转转 专注 拽爪转\nconst matchingTasks = [];\n\ngroups.forEach(group => {\n  matchingTasks.push({\n    group: group,\n    events: events\n  });\n});\n\nreturn matchingTasks.map(task => ({\n  json: task\n}));"
    },
    "name": "爪专转 砖转 转",
    "type": "n8n-nodes-base.function",
    "typeVersion": 1,
    "position": [
      1120,
      820
    ]
  },
  {
    "parameters": {
      "httpMethod": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "authentication": "predefinedCredentialType",
      "nodeCredentialName": "ChatGPT API",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "{\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"转 专 注 转转 专注 拽爪转 转. 转驻拽  专 转 专砖转 专注 转 -3 专注 转 转专 拽爪 住转, 转住住 注 驻 拽爪 转 注 砖.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \" 驻 拽爪:\\n\\n砖: {{ $json.group.name }}\\n转专: {{ $json.group.description }}\\n转 注: {{ $json.group.interests.join(\", \") }}\\n驻 拽爪: {{ $json.group.groupType }}\\n\\n 专砖转 专注 :\\n{% for event in $json.events %}\\n专注 {{ loop.index }}: {{ event.name }}\\n转专: {{ event.description }}\\n转专: {{ event.startDate }}\\n拽: {{ event.location }}\\n拽专转: {{ event.categories }}\\n\\n{% endfor %}\\n\\n专 转 3 专注 转 转专 拽爪  拽 转 专转.\"\n    }\n  ],\n  \"temperature\": 0.5\n}",
      "options": {}
      },
      "name": "转转 专注 拽爪",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1340,
        820
      ],
      "executeOnce": false
    },
    {
      "parameters": {
        "functionCode": "// 抓 专注 爪 住驻转 拽爪\nconst response = JSON.parse(items[0].json).choices[0].message.content;\nconst group = items[0].json.group;\nconst allEvents = items[0].json.events;\n\n// 抓 住驻专 专注 砖专\nconst selectedEventNumbers = [];\nconst regex = /专注 \\d+: *(\\d+)/g;\nlet match;\n\nwhile ((match = regex.exec(response)) !== null) {\n  const eventNumber = parseInt(match[1]);\n  if (!isNaN(eventNumber) && eventNumber > 0 && eventNumber <= allEvents.length) {\n    selectedEventNumbers.push(eventNumber - 1);  // -1  拽住 转 -0\n  }\n}\n\n// 拽转 专注 转\nconst selectedEvents = selectedEventNumbers.map(index => allEvents[index]);\n\nreturn [{\n  json: {\n    group: group,\n    recommendedEvents: selectedEvents,\n    explanation: response\n  }\n}];"
      },
      "name": "注 爪转 专注",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1560,
        820
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "groups",
        "document": "={{ $json.group._id }}",
        "updateKey": "recommendedEvents",
        "updateValue": "={{ $json.recommendedEvents }}"
      },
      "name": "注 专注 爪 拽爪",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        1780,
        820
      ]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialName": "Twilio API",
        "resource": "message",
        "operation": "send",
        "from": "whatsapp:+14155238886",
        "to": "whatsapp:+{{ $json.group.recipientsList }}",
        "content": "=爪 专注 砖 砖注砖 注 转 拽爪!\n\n{% for event in $json.recommendedEvents %}\n {{ event.name }}\n转专: {{ event.startDate }}\n拽: {{ event.location }}\n拽砖专: {{ event.url }}\n\n{% endfor %}\n\n 注转?  注 爪专祝?"
      },
      "name": "Twilio - 砖转 专注 拽爪",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        2000,
        820
      ]
    },
    {
      "parameters": {
        "incomingMethod": "POST",
        "respondWith": "json",
        "responseCode": 200,
        "responseData": "firstEntryJson",
        "options": {}
      },
      "name": "Webhook - 注转 住转 -Twilio",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        1300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.Body }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "name": "拽转 住 注",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        460,
        1300
      ]
    },
    {
      "parameters": {
        "functionCode": "// 抓 转 注 -Twilio\nconst messageData = {\n  text: items[0].json.Body,\n  from: items[0].json.From.replace('whatsapp:', ''),  // 住专 转 驻专驻拽住 砖 whatsapp:\n  timestamp: Date.now(),\n  chatId: items[0].json.To || ''\n};\n\n// 拽   注 拽爪转转 注 驻 驻专  metadata\nconst isGroupMessage = messageData.chatId.includes('group') || items[0].json.GroupSid;\n\nif (isGroupMessage) {\n  return [{\n    json: {\n      ...messageData,\n      isGroupMessage: true\n    }\n  }];\n} \n// 专转  注 砖转 驻\nelse {\n  return [{\n    json: {\n      ...messageData,\n      isGroupMessage: false,\n      userPhone: messageData.from\n    }\n  }];\n}"
      },
      "name": "抓 转 注",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        680,
        1180
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.isGroupMessage }}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "name": " 注 拽爪转转?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        900,
        1180
      ]
    },
    {
      "parameters": {
        "operation": "findOne",
        "collection": "groups",
        "options": {
          "sort": {},
          "limit": 1,
          "skip": 0,
          "projection": {},
          "filter": {
            "whatsappGroupId": "={{ $json.chatId }}"
          }
        }
      },
      "name": "爪转 驻专 拽爪",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        1120,
        1060
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialName": "ChatGPT API",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"转 驻住 拽爪转 砖 拽爪转 转. 转驻拽 拽 砖 , 注 砖转转驻 砖转祝, 注 专 驻注. 注 转  砖 转 驻注 注  转,  注 砖 砖 砖 拽砖专 专转 拽爪.\\n\\n注 注 拽爪:\\n砖: {{ $json.document.name }}\\n转专: {{ $json.document.description }}\\n转 注: {{ $json.document.interests.join(', ') }}\\n\\n 转 转   驻注, 住祝 转 转 拽爪, 注   注 .\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"注 砖 拽爪:\\n{{ $json.text }}\"\n    }\n  ],\n  \"temperature\": 0.7\n}",
        "options": {}
      },
      "name": "转 注 拽爪转转",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1340,
        1060
      ]
    },
    {
      "parameters": {
        "functionCode": "// 转 转转  拽爪转\nconst response = JSON.parse(items[0].json).choices[0].message.content;\nlet shouldRespond = true;\nlet responseMessage = response;\nlet isHarmfulContent = false;\n\n// 拽  转  转  驻注\nif (response.toLowerCase().includes('转 驻注') || \n    response.toLowerCase().includes('转') ||\n    response.toLowerCase().includes(' 转') ||\n    response.toLowerCase().includes('')) {\n  isHarmfulContent = true;\n}\n\n// 驻注  爪专 转\nif (response.toLowerCase().includes(' 爪专 转') || \n    response.toLowerCase().includes(' ')) {\n  shouldRespond = false;\n}\n\n// 专转 转爪转\nreturn [{\n  json: {\n    ...items[0].json,\n    groupManagerResponse: response,\n    shouldRespond: shouldRespond,\n    responseMessage: responseMessage,\n    isHarmfulContent: isHarmfulContent\n  }\n}];"
      },
      "name": "注 转转  拽爪转",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1560,
        1060
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.shouldRespond }}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "name": " ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1780,
        1060
      ]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialName": "Twilio API",
        "resource": "message",
        "operation": "send",
        "from": "whatsapp:+14155238886",
        "to": "whatsapp:={{ $json.userPhone }}",
        "content": "={{ $json.responseMessage }}"
      },
      "name": "Twilio - 转 拽爪",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        2000,
        940
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.isHarmfulContent }}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "name": " 砖 转 驻注?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2000,
        1180
      ]
    },
    {
      "parameters": {
        "operation": "findOne",
        "collection": "users",
        "options": {
          "filter": {
            "phone": "={{ $json.from }}"
          }
        }
      },
      "name": "爪转 驻专 砖转砖 驻注",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        2240,
        1060
      ]
    },
    {
      "parameters": {
        "operation": "findById",
        "collection": "users",
        "document": "={{ $json.document.personalTherapistId }}"
      },
      "name": "爪转 驻 砖",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        2460,
        1060
      ]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialName": "Twilio API",
        "resource": "message",
        "operation": "send",
        "from": "whatsapp:+14155238886",
        "to": "whatsapp:={{ $json.document.phone }}",
        "content": "=转专: 砖转砖 {{ $node[\"爪转 驻专 砖转砖 驻注\"].json.document.name }} 砖 注 砖转 驻注转 拽爪 {{ $node[\"爪转 驻专 拽爪\"].json.document.name }}.\n\n注: \"{{ $json.text }}\"\n\n转转  拽爪转: \"{{ $json.groupManagerResponse }}\"\n\n 转转  转砖转  驻转."
      },
      "name": "Twilio -  驻 砖",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        2680,
        1060
      ]
    },
    {
      "parameters": {
        "operation": "findOne",
        "collection": "users",
        "options": {
          "filter": {
            "phone": "={{ $json.userPhone }}"
          }
        }
      },
      "name": "爪转 砖转砖",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        1120,
        1300
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialName": "ChatGPT API",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"转 驻 砖 专 驻 专. 转  砖 注 驻 拽. 转驻拽 住驻拽 转, 拽砖, 注专 驻 转转 注 转专. 专 转 注 注 驻  转转 注 专.\\n\\n注 注 驻:\\n砖: {{ $json.document.name || ' 注' }}\\n转 注: {{ $json.document.interests ? $json.document.interests.join(', ') : ' 注' }}\\n转专 专转: {{ $json.document.socialChallenges ? $json.document.socialChallenges.join(', ') : ' 注' }}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"{{ $json.text }}\"\n    }\n  ],\n  \"temperature\": 0.7\n}",
        "options": {}
      },
      "name": "转转 驻 砖",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1340,
        1300
      ]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialName": "Twilio API",
        "resource": "message",
        "operation": "send",
        "from": "whatsapp:+14155238886",
        "to": "whatsapp:={{ $json.userPhone }}",
        "content": "={{ JSON.parse($json.data).choices[0].message.content }}"
      },
      "name": "Twilio - 砖转 转转 驻",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        1560,
        1300
      ]
    },
    {
      "parameters": {
        "resource": "webhook",
        "options": {}
      },
      "name": "Webhook - 住驻转 专注 转",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        240,
        1520
      ]
    },
    {
      "parameters": {
        "functionCode": "// 注 专注 砖 转\nconst eventData = items[0].json.body || {};\n\n// 专 驻专 \nconst processedEvent = {\n  source: 'Manual Entry',\n  id: `manual-${Date.now()}`,\n  name: eventData.name || '专注  砖',\n  description: eventData.description || '',\n  startDate: eventData.startDate || new Date().toISOString(),\n  endDate: eventData.endDate || '',\n  url: eventData.url || '',\n  location: eventData.location || ' 爪',\n  categories: eventData.categories || '',\n  isOnline: eventData.isOnline || false,\n  price: eventData.price || ' 爪',\n  imageUrl: eventData.imageUrl || ''\n};\n\nreturn [{\n  json: {\n    event: processedEvent\n  }\n}];"
      },
      "name": "注 专注 ",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        460,
        1520
      ]
    },
    {
      "parameters": {
        "operation": "create",
        "collection": "events",
        "fields": {
          "values": [
            {
              "name": "source",
              "value": "={{ $json.event.source }}"
            },
            {
              "name": "name",
              "value": "={{ $json.event.name }}"
            },
            {
              "name": "description",
              "value": "={{ $json.event.description }}"
            },
            {
              "name": "startDate",
              "value": "={{ $json.event.startDate }}"
            },
            {
              "name": "endDate",
              "value": "={{ $json.event.endDate }}"
            },
            {
              "name": "url",
              "value": "={{ $json.event.url }}"
            },
            {
              "name": "location",
              "value": "={{ $json.event.location }}"
            },
            {
              "name": "categories",
              "value": "={{ $json.event.categories }}"
            },
            {
              "name": "isOnline",
              "value": "={{ $json.event.isOnline }}"
            },
            {
              "name": "price",
              "value": "={{ $json.event.price }}"
            },
            {
              "name": "imageUrl",
              "value": "={{ $json.event.imageUrl }}"
            }
          ]
        }
      },
      "name": "住驻转 专注 住 转",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        680,
        1520
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"专注 住祝 爪\",\n  \"eventId\": \"{{ $node[\"住驻转 专注 住 转\"].json.insertedId }}\"\n}",
        "options": {}
      },
      "name": "转 住驻转 专注",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        900,
        1520
      ]
    }
  ],
  "connections": {
    "WhatsApp - 拽转 驻转 砖转": {
      "main": [
        [
          {
            "node": "ChatGPT - 驻 砖",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatGPT - 驻 砖": {
      "main": [
        [
          {
            "node": "拽转 砖 砖",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "拽转 砖 砖": {
      "main": [
        [
          {
            "node": "注 转砖转 驻",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 转砖转 驻": {
      "main": [
        [
          {
            "node": " 驻 砖?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " 驻 砖?": {
      "main": [
        [
          {
            "node": "砖专转 驻专驻 砖转砖",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WhatsApp - 拽转 驻转 砖转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "砖专转 驻专驻 砖转砖": {
      "main": [
        [
          {
            "node": "转转 砖转砖 拽爪",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Existing Groups": {
      "main": [
        [
          {
            "node": "注 拽爪转 拽转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "转转 砖转砖 拽爪": {
      "main": [
        [
          {
            "node": "注 转 ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 转 ": {
      "main": [
        [
          {
            "node": " 爪专 拽爪 砖?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " 爪专 拽爪 砖?": {
      "main": [
        [
          {
            "node": "爪专转 拽爪 砖",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Group Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爪专转 拽爪 砖": {
      "main": [
        [
          {
            "node": "爪专转 拽爪转 WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爪专转 拽爪转 WhatsApp": {
      "main": [
        [
          {
            "node": "注  拽爪转 WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注  拽爪转 WhatsApp": {
      "main": [
        [
          {
            "node": "注 拽爪 砖转砖 (砖)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Group Details": {
      "main": [
        [
          {
            "node": "住驻转 砖转砖 拽爪 拽转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "住驻转 砖转砖 拽爪 拽转": {
      "main": [
        [
          {
            "node": "注 拽爪 砖转砖 (拽转)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 拽爪 砖转砖 (拽转)": {
      "main": [
        [
          {
            "node": "住驻转 砖转砖 拽爪转 WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scheduler - 住专拽转 专注": {
      "main": [
        [
          {
            "node": "驻砖 专注 -Eventbrite",
            "type": "main",
            "index": 0
          },
          {
            "node": "驻砖 专注 -Meetup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "驻砖 专注 -Eventbrite": {
      "main": [
        [
          {
            "node": "注 转 专注",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "驻砖 专注 -Meetup": {
      "main": [
        [
          {
            "node": "注 转 专注",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "注 转 专注": {
      "main": [
        [
          {
            "node": "拽转  拽爪转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "拽转  拽爪转": {
      "main": [
        [
          {
            "node": "爪专转 砖转 转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爪专转 砖转 转": {
      "main": [
        [
          {
            "node": "转转 专注 拽爪",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "转转 专注 拽爪": {
      "main": [
        [
          {
            "node": "注 爪转 专注",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 爪转 专注": {
      "main": [
        [
          {
            "node": "注 专注 爪 拽爪",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 专注 爪 拽爪": {
      "main": [
        [
          {
            "node": "砖转 专注 拽爪转 WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - 注转 住转 -Twilio": {
      "main": [
        [
          {
            "node": "拽转 住 注",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "拽转 住 注": {
      "main": [
        [
          {
            "node": "抓 转 注",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "抓 转 注": {
      "main": [
        [
          {
            "node": " 注 拽爪转转?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " 注 拽爪转转?": {
      "main": [
        [
          {
            "node": "爪转 驻专 拽爪",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "爪转 砖转砖",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爪转 驻专 拽爪": {
      "main": [
        [
          {
            "node": "转 注 拽爪转转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "转 注 拽爪转转": {
      "main": [
        [
          {
            "node": "注 转转  拽爪转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 转转  拽爪转": {
      "main": [
        [
          {
            "node": " ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " ?": {
      "main": [
        [
          {
            "node": "转 拽爪",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": " 砖 转 驻注?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " 砖 转 驻注?": {
      "main": [
        [
          {
            "node": "爪转 驻专 砖转砖 驻注",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "爪转 驻专 砖转砖 驻注": {
      "main": [
        [
          {
            "node": "爪转 驻 砖",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爪转 驻 砖": {
      "main": [
        [
          {
            "node": " 驻 砖",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爪转 砖转砖": {
      "main": [
        [
          {
            "node": "转转 驻 砖",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "转转 驻 砖": {
      "main": [
        [
          {
            "node": "砖转 转转 驻",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - 住驻转 专注 转": {
      "main": [
        [
          {
            "node": "注 专注 ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "注 专注 ": {
      "main": [
        [
          {
            "node": "住驻转 专注 住 转",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "住驻转 专注 住 转": {
      "main": [
        [
          {
            "node": "转 住驻转 专注",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
    
